name: PRAgent on SelfHosted Runner (No Docker)
true:
  pull_request:
    types:
    - opened
    - reopened
    - ready_for_review
jobs:
  pr_agent_job:
    if: ${{ github.event.sender.type != 'Bot' }}
    runs-on:
    - self-hosted
    - windows
    permissions:
      issues: write
      pull-requests: write
      contents: write
    env:
      PYTHONPATH: ${{ github.workspace }}\\pr_agent_code
      RUNNER_TOOL_CACHE: C:\\actions-runner\\toolcache
      OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
      OPENAI__KEY: ${{ secrets.OPENAI_KEY }}
      ANTHROPIC__KEY: ${{ secrets.ANTHROPIC_KEY }}
      ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CSHARP_CODE_CONTEXT_SERVICE__BASE_URL: https://localhost:7110
      CSHARP_CODE_CONTEXT_SERVICE__USERNAME: Skatamatic
      CSHARP_CODE_CONTEXT_SERVICE__PASSWORD: ${{ secrets.CONTEXT_PASSWORD }}
      GITHUB_EVENT_PATH: ${{ github.event_path }}
      GITHUB_EVENT_NAME: ${{ github.event_name }}
      PYTHONUTF8: 1
    steps:
    - name: Checkout PRAgent fork (CodeContextIntegration)
      uses: actions/checkout@v4
      with:
        repository: skatamatic/pr-agent
        ref: Dashboard
        path: pr_agent_code
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: 3.12
        cache: pip
        cache-dependency-path: pr_agent_code/requirements.txt
    - name: Save / restore pip wheel cache
      uses: actions/cache@v4
      with:
        path: '${{ env.LOCALAPPDATA }}\pip\Cache

          ~/.cache/pip

          '
        key: ${{ runner.os }}-pip-${{ hashFiles('pr_agent_code/requirements.txt')
          }}
        restore-keys: '${{ runner.os }}-pip-

          '
    - name: Install PRAgent requirements
      run: 'pip install --upgrade pip

        pip install -r pr_agent_code/requirements.txt

        '
    - name: Export GITHUB_ACTION_CONFIG.AUTO_IMPROVE env var
      shell: powershell
      run: '# Append to $GITHUB_ENV so it''s visible in the next steps

        Add-Content $env:GITHUB_ENV "GITHUB_ACTION_CONFIG.AUTO_IMPROVE=true"

        '
    - name: Mirror event.json to legacy location
      shell: powershell
      run: '$legacy = "$env:GITHUB_WORKSPACE\github\workflow"

        New-Item -ItemType Directory -Force -Path $legacy | Out-Null

        Copy-Item -Force $env:GITHUB_EVENT_PATH "$legacy\event.json"

        # update the variable so the runner script sees the legacy path

        Add-Content $env:GITHUB_ENV "GITHUB_EVENT_PATH=$legacy\\event.json"

        '
    - name: Run PRAgent
      shell: powershell
      working-directory: pr_agent_code
      run: 'python pr_agent/servers/github_action_runner.py

        '
